---
title: "PCA Analysis on Text Representations"
author: "A Math 232 Final Project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Matrix)
library(irlba)
```

## Define PCA Function

```{r}
run_pca <- function(filepath, k = 10, output_suffix) {
  # 1: Load data
  data <- read.csv(filepath, header = TRUE, row.names = 1)

  # 2: Determine method of PCA
  use_irlba <- grepl("bow", tolower(filepath)) # use irlba for BoW - truncated PCA

  if (use_irlba) {
    X <- Matrix(as.matrix(data), sparse = TRUE)
    pca_result <- prcomp_irlba(X, n = k, center = TRUE, scale. = FALSE)
    projection <- pca_result$x
    loadings <- pca_result$rotation
    sdev <- pca_result$sdev
  } else {
    X <- as.matrix(data)
    pca_result <- prcomp(X, center = TRUE, scale. = FALSE)
    projection <- pca_result$x[, 1:k]
    loadings <- pca_result$rotation[, 1:k]
    sdev <- pca_result$sdev[1:k]
  }

  # 3: Output files
  write.csv(as.data.frame(projection), paste0("~/Desktop/X_train_pca", output_suffix))
  write.csv(as.data.frame(loadings), paste0("~/Desktop/X_train_loadings", output_suffix))
  write.csv(sdev^2 / sum(sdev^2), paste0("~/Desktop/X_train_variance", output_suffix))
}
```

## Prepare GloVe Data

```{r}
glove_avg_train <- read.csv("~/Desktop/glove_train_avg.csv", row.names = NULL)
rownames(glove_avg_train) <- 1:nrow(glove_avg_train)
write.csv(glove_avg_train, "glove_avg_train.csv", row.names = TRUE)

glove_tfidf_train <- read.csv("~/Desktop/glove_train_tfidf.csv", row.names = NULL)
rownames(glove_tfidf_train) <- 1:nrow(glove_tfidf_train)
write.csv(glove_tfidf_train, "glove_tfidf_train.csv", row.names = TRUE)
```

## Run PCA on Training Data

```{r}
pca_bow <- run_pca("~/Desktop/bow_train_matrix.csv", k = 10, output_suffix = "_bow.csv")
pca_glove_avg <- run_pca("~/Desktop/glove_avg_train.csv", k = 10, output_suffix = "_glove_avg.csv")
pca_glove_tfidf <- run_pca("~/Desktop/glove_tfidf_train.csv", k = 10, output_suffix = "_glove_tfidf.csv")
```

## Define Test Projection Function

```{r}
project_test_pca <- function(train_path, test_path, output_name, k = 10, use_irlba = FALSE) {
  # 1: Load data
  X_train <- read.csv(train_path, row.names = 1)
  X_train <- as.matrix(X_train)
  X_test <- read.csv(test_path, row.names = 1)
  X_test <- as.matrix(X_test)

  # 2: Run PCA
  if (use_irlba) {
    X_train_sparse <- Matrix(X_train, sparse = TRUE)
    pca_result <- prcomp_irlba(X_train_sparse, n = k, center = TRUE, scale. = FALSE)
  } else {
    pca_result <- prcomp(X_train, center = TRUE, scale. = FALSE)
  }

  # 3: Center and project test data
  X_test_centered <- scale(X_test, center = pca_result$center, scale = FALSE)
  Z_test <- X_test_centered %*% pca_result$rotation[, 1:k]
  rownames(Z_test) <- 1:nrow(Z_test)

  # 4: Save projected test matrix
  write.csv(as.data.frame(Z_test), paste0("~/Desktop/", output_name, ".csv"), row.names = TRUE)
}
```

## Project Test Data

```{r}
project_test_pca(train_path = "~/Desktop/bow_train_matrix.csv",
                 test_path = "~/Desktop/bow_test_matrix.csv",
                 output_name = "Z_test_pca_bow", k = 10, use_irlba = TRUE)

project_test_pca(train_path = "~/Desktop/glove_avg_train.csv",
                 test_path = "~/Desktop/glove_avg_test.csv",
                 output_name = "Z_test_pca_glove_avg", k = 10, use_irlba = FALSE)

project_test_pca(train_path = "~/Desktop/glove_tfidf_train.csv",
                 test_path = "~/Desktop/glove_tfidf_test.csv",
                 output_name = "Z_test_pca_glove_tfidf", k = 10, use_irlba = FALSE)
```
